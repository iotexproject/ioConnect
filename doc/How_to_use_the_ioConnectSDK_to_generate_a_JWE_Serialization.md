

# How to use the ioConnect SDK to generate a JWE Serialization 

JSON Web Encryption (JWE) represents encrypted content using JSON- based data structures [RFC7159]. The JWE cryptographic mechanisms encrypt and provide integrity protection for an arbitrary sequence of octets. Two closely related serializations for JWEs are defined. The JWE Compact Serialization is a compact, URL-safe representation intended for space constrained environments such as HTTP Authorization headers and URI query parameters. The JWE JSON Serialization represents JWEs as JSON objects and enables the same content to be encrypted to multiple parties. Both share the same cryptographic underpinnings.



## JSON Web Encryption (JWE) Overview

JJWE represents encrypted content using JSON data structures and base64url encoding. These JSON data structures MAY contain whitespace and/or line breaks before or after any JSON values or structural characters, in accordance with Section 2 of RFC 7159 [RFC7159]. A JWE represents these logical values :

- JOSE Header
- JWE Encrypted Key
- JWE Initialization Vector
- JWE AAD
- JWE Ciphertext
- JWE Authentication Tag

For a JWE, the JOSE Header members are the union of the members of these values：

- JWE Protected Header
- JWE Shared Unprotected Header
- JWE Per-Recipient Unprotected Header

JWE utilizes authenticated encryption to ensure the confidentiality and integrity of the plaintext and the integrity of the JWE Protected Header and the JWE AAD.

This document defines two serializations for JWEs: a compact, URL- safe serialization called the JWE Compact Serialization and a JSON serialization called the JWE JSON Serialization. In both serializations, the JWE Protected Header, JWE Encrypted Key, JWE Initialization Vector, JWE Ciphertext, and JWE Authentication Tag are base64url encoded, since JSON lacks a way to directly represent arbitrary octet sequences. When present, the JWE AAD is also base64url encoded.

### JWE Compact Serialization Overview

In the JWE Compact Serialization, no JWE Shared Unprotected Header or JWE Per-Recipient Unprotected Header are used. In this case, the JOSE Header and the JWE Protected Header are the same.

In the JWE Compact Serialization, a JWE is represented as the concatenation:
$$
BASE64URL(UTF8(JWE Protected Header)) || ’.’ ||
 BASE64URL(JWE Encrypted Key) || ’.’ ||
 BASE64URL(JWE Initialization Vector) || ’.’ ||
 BASE64URL(JWE Ciphertext) || ’.’ ||
 BASE64URL(JWE Authentication Tag)
$$

### JWE JSON Serialization Overview

In the JWE JSON Serialization, one or more of the JWE Protected Header, JWE Shared Unprotected Header, and JWE Per-Recipient Unprotected Header MUST be present. In this case, the members of the JOSE Header are the union of the members of the JWE Protected Header, JWE Shared Unprotected Header, and JWE Per-Recipient Unprotected Header values that are present.

In the JWE JSON Serialization, a JWE is represented as a JSON object containing some or all of these eight members:

- "protected", with the value BASE64URL(UTF8(JWE Protected Header))
- "unprotected", with the value JWE Shared Unprotected Header
- "header", with the value JWE Per-Recipient Unprotected Header
- "encrypted_key", with the value BASE64URL(JWE Encrypted Key)
- "iv", with the value BASE64URL(JWE Initialization Vector)
- "ciphertext", with the value BASE64URL(JWE Ciphertext)
- "tag", with the value BASE64URL(JWE Authentication Tag)
- "aad", with the value BASE64URL(JWE AAD)

The six base64url-encoded result strings and the two unprotected JSON object values are represented as members within a JSON object. The inclusion of some of these values is OPTIONAL. The JWE JSON Serialization can also encrypt the plaintext to multiple recipients.



## Standards and Protocols

- **Internet Engineering Task Force (IETF)**:
- [RFC 7516 - JSON Web Encryption (JWE) (ietf.org)](https://datatracker.ietf.org/doc/rfc7516/)



## API

```c
// Generate a JWE serialization.(Encrypt)
// Params [plaintext] : Plaintext data.
// Params [enum KWAlgorithms] : Support the algorithms of KA. See Definition.
// Params [enum EncAlgorithm] : Support the algorithms of Encrypt. See Definition.
// Params [sender] : a DID of sender.
// Params [JWK *] : a JWK of sender.
// Params [recipients_kid] : recipients' KID.
// Params [format] : true : output with formatting, false : output without formatting.
// Return [char *] : a JWE serialization if successful, or NULL if failed.

char *iotex_jwe_encrypt(char *plaintext, enum KWAlgorithms alg, enum EncAlgorithm enc, char *sender, JWK *sJWK, char *recipients_kid[JOSE_JWE_RECIPIENTS_MAX], bool format);
```



```c
// Decrypting the JWE message.
// Params [jwe_serialize] : JWE message generated by "iotex_jwe_encrypt".
// Params [enum KWAlgorithms] : Support the algorithms of KA. See Definition.
// Params [enum EncAlgorithm] : Support the algorithms of Encrypt. See Definition.
// Params [sender] : a DID of sender.
// Params [JWK *] : a JWK of sender.
// Params [recipients_kid] : An array that can contain one or more recipients' KIDs.
// Return [JWK *] : If the plaintext data is decrypted successfully, or NULL if failed.

char *iotex_jwe_decrypt(char *jwe_serialize, enum KWAlgorithms alg, enum EncAlgorithm enc, char *sender, JWK *sJWK, char *recipients_kid);
```



```c
// Generate a JWE Compact serialization.(Encrypt)
// Params [key_id] : Encrypted keyid
// Params [plaintext] : Plaintext data.
// Params [pLen] : a size of the Plaintext data.
// Params [nonce] : Buffer containing the nonce to use.
// Params [nonce_len] : a size of the nonce.
// Params [ad] : Buffer containing the additional data.
// Params [ad_len] : a size of the ad.
// Params [ciphertext_length][out]: a sizeof JWE Compact serialization if successful, or 0 if failed.
// Return [char *] : a JWE Compact serialization if successful, or NULL if failed.

char *iotex_jwe_encrypt_plaintext(psa_key_id_t key_id, char *plaintext, size_t pLen, char *nonce, size_t nonce_len, char *ad, size_t ad_len, size_t *ciphertext_length);
```



## Definition

### enum KWAlgorithms

```c
enum KWAlgorithms {
    Ecdh1puA256kw,      // rename = "ECDH-1PU+A256KW"
    EcdhEsA256kw,       // rename = "ECDH-ES+A256KW"
};
```



### enum EncAlgorithm

```c
enum EncAlgorithm {
    A256cbcHs512,       // rename = "A256CBC-HS512"
    Xc20P,              // rename = "XC20P"
    A256Gcm,            // rename = "A256GCM"
};
```



## Example

```c
char *recipients_kid[JOSE_JWE_RECIPIENTS_MAX] = {0};
recipients_kid[0] = peerdid_kid;
char *jwe_json = iotex_jwe_encrypt("This is a JWE Test", Ecdh1puA256kw, A256cbcHs512, did_io, jwk, recipients_kid, true);
if (jwe_json)      
    printf("JWE JSON Serialize : \n%s\n", jwe_json);

char *jwe_plaintext = iotex_jwe_decrypt(jwe_json, Ecdh1puA256kw, A256cbcHs512, did_io, jwk, peerdid_kid);
if (jwe_plaintext)
    printf("JWE Decrypted Plaintext : \n%s\n", jwe_plaintext);  
```



## output

```
JWE JSON Serialize :
{
        "ciphertext":   "0wsBa8vvPMX40NOysQcUCvV_",
        "protected":    "eyJ0eXAiOiJhcHBsaWNhdGlvbi9kaWRjb21tLWVuY3J5cHRlZCtqc29uIiwiYWxnIjoiRUNESC0xUFUrQTI1NktXIiwiZW5jIjoiQTI1NkNCQy1IUzUxMiIsInNraWQiOiJkaWQ6aW86MHg3YjVkOWJhNTEzYzM2MGYzNTFhZTRmYTUyNDBmNTlkMmE5NTQ4ZDJmIiwiYXB1IjoiWkdsa09tbHZPakI0TjJJMVpEbGlZVFV4TTJNek5qQm1NelV4WVdVMFptRTFNalF3WmpVNVpESmhPVFUwT0dReVpnIiwiYXB2IjoiZ1JMQXVtaVg5M3BYYlZTWjhsSkpMbE5XcE5Za2dNTmVUTWYwS2NJb29ONCIsImVwayI6eyJjcnYiOiJQLTI1NiIsIngiOiJzanBGT3laUDdwS3NQVFpOWi1aYWpVX25QQlk2OXJRX2FiTk1XQ0pUdTJzIiwieSI6InpXZmFWenB6elJYRFpsTVIwUk1RQ05fa25SVC1vSUR0RHVfVmpRTi1kR1UiLCJrdHkiOiJFQyIsImtpZCI6IktleS1wMjU2LTIxNDc0ODM2MjEifX0",
        "recipients":   [{
                        "header":       {
                                "kid":  "did:io:0x2c914fec7c720314384bee56af00caafdd66e6fe#Key-p256-2147483617"
                        },
                        "encrypted_key":        "56ROJN5c-ejmI7nemGOxM5nKTZnwRaia5XEx5DscI5bebzBjdXWdPvcCNBttL7Ua"
                }],
        "tag":  "5WA302WuKs3jUY1p7ObDvQ",
        "iv":   "Igu1KMmvdUbV75ZQ5g"
}
JWE Decrypted Plaintext :
This is a JWE Test
```











